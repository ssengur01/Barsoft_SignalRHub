<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barsoft SignalR Hub - Client Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .event-log {
            height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            padding: 15px;
            border-radius: 4px;
        }
        .event-item {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid #007bff;
            background: rgba(0, 123, 255, 0.1);
        }
        .event-created { border-left-color: #28a745; background: rgba(40, 167, 69, 0.1); }
        .event-updated { border-left-color: #ffc107; background: rgba(255, 193, 7, 0.1); }
        .event-error { border-left-color: #dc3545; background: rgba(220, 53, 69, 0.1); }
        .status-disconnected { color: #dc3545; }
        .status-connecting { color: #ffc107; }
        .status-connected { color: #28a745; }
        .timestamp { color: #6c757d; font-size: 11px; }
        .badge-custom { font-size: 12px; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">
            <span class="badge bg-primary">Barsoft SignalR Hub</span>
            Real-time Stock Movement Demo
        </h1>

        <!-- Connection Status -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Connection Status</h5>
                <p>
                    Status: <strong id="connectionStatus" class="status-disconnected">Disconnected</strong>
                    <span id="connectionInfo" class="text-muted ms-3"></span>
                </p>
                <p id="userInfo" class="mb-0"></p>
            </div>
        </div>

        <!-- Login Section -->
        <div class="card" id="loginSection">
            <div class="card-body">
                <h5 class="card-title">Login</h5>
                <form id="loginForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">API URL</label>
                            <input type="text" class="form-control" id="apiUrl" value="https://localhost:5001">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">User Code</label>
                            <input type="text" class="form-control" id="userCode" value="0001" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" value="password" required>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Login & Connect</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="card" id="controlPanel" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">Control Panel</h5>
                <button class="btn btn-success" id="btnPing">Ping Server</button>
                <button class="btn btn-info" id="btnGetGroups">Get My Groups</button>
                <button class="btn btn-warning" id="btnClearLog">Clear Log</button>
                <button class="btn btn-danger" id="btnDisconnect">Disconnect</button>
            </div>
        </div>

        <!-- Group Membership -->
        <div class="card" id="groupCard" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">Group Membership (Multi-Tenant)</h5>
                <div id="groupInfo"></div>
            </div>
        </div>

        <!-- Event Statistics -->
        <div class="row" id="statsSection" style="display: none;">
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h6 class="card-title">Created Events</h6>
                        <h2 id="createdCount">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h6 class="card-title">Updated Events</h6>
                        <h2 id="updatedCount">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h6 class="card-title">Total Events</h6>
                        <h2 id="totalCount">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Log -->
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">Event Log (Real-time)</h5>
                <div class="event-log" id="eventLog">
                    <div class="text-muted">Waiting for connection...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- SignalR Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>

    <script>
        let connection = null;
        let jwtToken = null;
        let apiUrl = null;
        let eventCounts = { created: 0, updated: 0, total: 0 };

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const controlPanel = document.getElementById('controlPanel');
        const groupCard = document.getElementById('groupCard');
        const statsSection = document.getElementById('statsSection');
        const eventLog = document.getElementById('eventLog');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionInfo = document.getElementById('connectionInfo');
        const userInfo = document.getElementById('userInfo');
        const groupInfo = document.getElementById('groupInfo');

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            apiUrl = document.getElementById('apiUrl').value;
            const userCode = document.getElementById('userCode').value;
            const password = document.getElementById('password').value;

            try {
                logEvent('INFO', 'Attempting login...');

                // Login and get JWT token
                const response = await fetch(`${apiUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userCode, password })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`Login failed: ${error}`);
                }

                const data = await response.json();
                jwtToken = data.token;

                logEvent('SUCCESS', `Login successful! User: ${data.user.userCode} (${data.user.description})`);
                logEvent('INFO', `Admin: ${data.user.isAdmin}, SubeIds: [${data.user.subeIds.join(', ')}]`);

                userInfo.innerHTML = `
                    <strong>Logged in as:</strong> ${data.user.userCode} (${data.user.description})
                    <span class="badge bg-${data.user.isAdmin ? 'danger' : 'secondary'} ms-2">
                        ${data.user.isAdmin ? 'Admin' : 'User'}
                    </span>
                    <span class="badge bg-info ms-2">Branches: ${data.user.subeIds.join(', ')}</span>
                `;

                // Connect to SignalR
                await connectSignalR();

            } catch (error) {
                logEvent('ERROR', error.message);
                alert('Login failed: ' + error.message);
            }
        });

        // Connect to SignalR Hub
        async function connectSignalR() {
            try {
                updateStatus('Connecting', 'connecting');
                logEvent('INFO', 'Connecting to SignalR Hub...');

                connection = new signalR.HubConnectionBuilder()
                    .withUrl(`${apiUrl}/hubs/stokhareket`, {
                        accessTokenFactory: () => jwtToken
                    })
                    .configureLogging(signalR.LogLevel.Information)
                    .withAutomaticReconnect([0, 2000, 5000, 10000])
                    .build();

                // Event Handlers
                connection.on("StokHareketCreated", (event) => {
                    eventCounts.created++;
                    eventCounts.total++;
                    updateStats();
                    logEvent('CREATED', JSON.stringify(event, null, 2));
                });

                connection.on("StokHareketUpdated", (event) => {
                    eventCounts.updated++;
                    eventCounts.total++;
                    updateStats();
                    logEvent('UPDATED', JSON.stringify(event, null, 2));
                });

                connection.on("StokHareketReceived", (event) => {
                    // Generic handler - already counted in specific handlers
                    console.log('StokHareketReceived:', event);
                });

                // Connection State Handlers
                connection.onclose((error) => {
                    updateStatus('Disconnected', 'disconnected');
                    logEvent('ERROR', error ? `Connection closed: ${error.message}` : 'Connection closed');
                    showLoginUI();
                });

                connection.onreconnecting((error) => {
                    updateStatus('Reconnecting...', 'connecting');
                    logEvent('WARNING', 'Reconnecting...');
                });

                connection.onreconnected((connectionId) => {
                    updateStatus('Connected', 'connected', connectionId);
                    logEvent('SUCCESS', `Reconnected! ConnectionId: ${connectionId}`);
                });

                // Start connection
                await connection.start();

                updateStatus('Connected', 'connected', connection.connectionId);
                logEvent('SUCCESS', `SignalR Connected! ConnectionId: ${connection.connectionId}`);

                showControlUI();

                // Auto-fetch groups
                await getMyGroups();

            } catch (error) {
                updateStatus('Failed', 'disconnected');
                logEvent('ERROR', `Connection failed: ${error.message}`);
                alert('SignalR connection failed: ' + error.message);
            }
        }

        // Control Panel Actions
        document.getElementById('btnPing').addEventListener('click', async () => {
            try {
                const result = await connection.invoke("Ping");
                logEvent('INFO', `Ping response: ${result}`);
                alert(result);
            } catch (error) {
                logEvent('ERROR', `Ping failed: ${error.message}`);
            }
        });

        document.getElementById('btnGetGroups').addEventListener('click', getMyGroups);

        async function getMyGroups() {
            try {
                const result = await connection.invoke("GetMyGroups");
                logEvent('INFO', `Groups: ${JSON.stringify(result, null, 2)}`);

                groupInfo.innerHTML = `
                    <p><strong>User Code:</strong> ${result.userCode}</p>
                    <p><strong>Sube IDs:</strong> <span class="badge bg-primary">${result.subeIds.join('</span> <span class="badge bg-primary">')}</span></p>
                    <p><strong>SignalR Groups:</strong> <span class="badge bg-success">${result.groups.join('</span> <span class="badge bg-success">')}</span></p>
                    <p><strong>Connection ID:</strong> <code>${result.connectionId}</code></p>
                `;

                groupCard.style.display = 'block';
            } catch (error) {
                logEvent('ERROR', `GetMyGroups failed: ${error.message}`);
            }
        }

        document.getElementById('btnClearLog').addEventListener('click', () => {
            eventLog.innerHTML = '<div class="text-muted">Log cleared</div>';
            eventCounts = { created: 0, updated: 0, total: 0 };
            updateStats();
        });

        document.getElementById('btnDisconnect').addEventListener('click', async () => {
            if (connection) {
                await connection.stop();
                showLoginUI();
            }
        });

        // Helper Functions
        function updateStatus(text, className, connectionId = '') {
            connectionStatus.textContent = text;
            connectionStatus.className = `status-${className}`;
            connectionInfo.textContent = connectionId ? `(${connectionId})` : '';
        }

        function logEvent(type, message) {
            const timestamp = new Date().toLocaleTimeString('tr-TR', { hour12: false, fractionalSecondDigits: 3 });
            const eventClass = type === 'CREATED' ? 'event-created' :
                              type === 'UPDATED' ? 'event-updated' :
                              type === 'ERROR' || type === 'WARNING' ? 'event-error' :
                              'event-item';

            const eventHtml = `
                <div class="${eventClass}">
                    <div class="timestamp">[${timestamp}]</div>
                    <strong>${type}:</strong> <pre style="margin: 5px 0 0 0; white-space: pre-wrap;">${message}</pre>
                </div>
            `;

            eventLog.insertAdjacentHTML('afterbegin', eventHtml);

            // Keep only last 100 events
            while (eventLog.children.length > 100) {
                eventLog.removeChild(eventLog.lastChild);
            }
        }

        function updateStats() {
            document.getElementById('createdCount').textContent = eventCounts.created;
            document.getElementById('updatedCount').textContent = eventCounts.updated;
            document.getElementById('totalCount').textContent = eventCounts.total;
        }

        function showLoginUI() {
            loginSection.style.display = 'block';
            controlPanel.style.display = 'none';
            groupCard.style.display = 'none';
            statsSection.style.display = 'none';
        }

        function showControlUI() {
            loginSection.style.display = 'none';
            controlPanel.style.display = 'block';
            statsSection.style.display = 'flex';
        }

        // Initialize
        logEvent('INFO', 'Demo loaded. Please login to start.');
    </script>
</body>
</html>
